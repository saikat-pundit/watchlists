name: Fetch BSE Market Data

on:
  schedule:
    # Run at 6:00 PM IST daily (12:30 UTC)
    - cron: '30 12 * * *'
  workflow_dispatch:  # Allow manual trigger
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  fetch-bse-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        persist-credentials: false
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create data directory
      run: mkdir -p data
    
    - name: Fetch BSE data
      run: |
        python src/bse_fetcher.py --output-dir data --save-json
      env:
        TZ: Asia/Kolkata
    
    - name: Check if new data was fetched
      id: check-data
      run: |
        # Check if any CSV files were created/modified today
        if ls data/*.csv 1> /dev/null 2>&1; then
          echo "New data files found"
          echo "has_data=true" >> $GITHUB_OUTPUT
        else
          echo "No new data files"
          echo "has_data=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit and push if data changed
      if: steps.check-data.outputs.has_data == 'true'
      run: |
        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add data files
        git add data/*.csv data/*.json
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          # Get current date for commit message
          CURRENT_DATE=$(date +"%Y-%m-%d")
          
          # Commit changes
          git commit -m "Auto-update: BSE market data for $CURRENT_DATE [skip ci]"
          
          # Push changes
          git push origin HEAD:${{ github.ref }}
        fi
    
    - name: Upload data as artifact
      uses: actions/upload-artifact@v3
      with:
        name: bse-market-data
        path: data/
        retention-days: 7
    
    - name: Create summary report
      if: always()
      run: |
        echo "# BSE Data Fetch Report" > $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Run Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.check-data.outputs.has_data }}" = "true" ]; then
          echo "✅ **Status:** Successfully fetched new data" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # List latest files
          echo "**Latest Files:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -la data/*.csv | tail -5 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Show file sizes
          echo "**File Sizes:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          du -h data/*.csv | tail -5 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **Status:** No new data fetched" >> $GITHUB_STEP_SUMMARY
        fi
