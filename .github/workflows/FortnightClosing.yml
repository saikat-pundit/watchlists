name: Fortnight Closing

on:
  workflow_dispatch:  # Manual trigger from Actions tab
  schedule:
    - cron: '15 0 1,16 * *'

jobs:
  check-time:
    runs-on: ubuntu-latest
    outputs:
      allowed: ${{ steps.check.outputs.allowed }}
    
    steps:
    - name: Check if current time is within allowed window
      id: check
      run: |
        # Set timezone to IST
        export TZ="Asia/Kolkata"
        
        # Get current date and time in IST
        CURRENT_DAY=$(date +'%d')
        CURRENT_MONTH=$(date +'%m')
        CURRENT_YEAR=$(date +'%Y')
        CURRENT_HOUR=$(date +'%H')
        CURRENT_MINUTE=$(date +'%M')
        CURRENT_TIME=$(date +'%H:%M')
        CURRENT_DATE=$(date +'%d-%m-%Y')
        
        # Check if today is 1st or 16th of the month
        if [[ "$CURRENT_DAY" != "01" ]] && [[ "$CURRENT_DAY" != "16" ]]; then
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "❌ Today is $CURRENT_DATE - not the 1st or 16th of the month"
            echo "❌ Manual trigger is only allowed on 1st and 16th of each month"
            echo "allowed=false" >> $GITHUB_OUTPUT
            exit 1
          else
            # For schedule trigger on wrong day (shouldn't happen with cron)
            echo "Schedule trigger on non-allowed day - allowing for safety"
            echo "allowed=true" >> $GITHUB_OUTPUT
          fi
        else
          # Today is 1st or 16th, check time for manual triggers
          echo "✅ Today is $CURRENT_DATE - allowed day (1st or 16th)"
          
          # For schedule triggers, always allow on allowed days
          if [[ "${{ github.event_name }}" != "workflow_dispatch" ]]; then
            echo "Schedule trigger on allowed day - bypassing time check"
            echo "allowed=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # For workflow_dispatch, check time window (00:00 to 08:55 IST)
          # Convert time to minutes for easier comparison
          CURRENT_HOUR_INT=$((10#$CURRENT_HOUR))
          CURRENT_MINUTE_INT=$((10#$CURRENT_MINUTE))
          CURRENT_MINUTES=$((CURRENT_HOUR_INT * 60 + CURRENT_MINUTE_INT))
          
          # Calculate 08:55 in minutes
          END_HOUR=08
          END_MINUTE=55
          END_MINUTES=$((END_HOUR * 60 + END_MINUTE))
          
          echo "Current time: $CURRENT_TIME IST ($CURRENT_MINUTES minutes)"
          echo "Allowed until: 08:55 IST ($END_MINUTES minutes)"
          
          # Check if current time is between 00:00 and 08:55
          if [[ $CURRENT_MINUTES -ge 0 ]] && [[ $CURRENT_MINUTES -le $END_MINUTES ]]; then
            echo "✅ Current time $CURRENT_TIME IST is within allowed window (00:00-08:55 IST)"
            echo "allowed=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Current time $CURRENT_TIME IST is outside allowed window (00:00-08:55 IST)"
            echo "❌ Manual trigger is only allowed between 00:00 and 08:55 IST on 1st and 16th"
            echo "allowed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        fi

  process-csv:
    runs-on: ubuntu-latest
    needs: check-time
    if: needs.check-time.outputs.allowed == 'true'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Process CSV files and extract data
      run: |
        echo "Processing CSV files..."
        
        # Get current timestamp in IST - IMPORTANT: Set TZ first
        export TZ="Asia/Kolkata"
        TIMESTAMP_IST=$(date +'%d-%b %H:%M')
        
        # Create header for output file
        echo "Index_Name,Closing_Value" > Data/QuarterlyClosing.csv
        
        # Read each required index from BSE.csv
        {
          echo "NIFTY 50"
          echo "FINANCIAL SERVICES"
          echo "BSE Information Technology"
          echo "BSE OIL & GAS"
          echo "AUTO"
          echo "FMCG"
          echo "PHARMA"
          echo "BSE CAPITAL GOODS"
          echo "BSE POWER"
          echo "BSE Consumer Discretionary"
          echo "BSE Telecommunication"
          echo "METAL"
          echo "BSE CONSUMER DURABLES"
          echo "REALTY"
          echo "SERVICES SECTOR"
          echo "BSE India Infrastructure Index"
          echo "BSE Commodities"
        } | while read -r index_name; do
          
          # Try to find in BSE.csv first with exact match
          if [ -f "Data/BSE.csv" ]; then
            # Extract second column where first column matches exactly
            result=$(awk -F',' -v idx="$index_name" '
            BEGIN {found=0} 
            $1 == idx {print $2; found=1; exit} 
            END {if (!found) print "N/A"}' "Data/BSE.csv")
          else
            result="N/A"
          fi
          
          # If not found in BSE.csv with exact match, try nse_all_indices.csv with exact match
          if [ "$result" = "N/A" ] || [ -z "$result" ]; then
            if [ -f "Data/nse_all_indices.csv" ]; then
              result=$(awk -F',' -v idx="$index_name" '
              BEGIN {found=0} 
              $1 == idx {print $2; found=1; exit} 
              END {if (!found) print "N/A"}' "Data/nse_all_indices.csv")
            fi
          fi
          
          # If still not found, try case-insensitive exact word match (excluding surrounding spaces)
          if [ "$result" = "N/A" ] || [ -z "$result" ]; then
            if [ -f "Data/BSE.csv" ]; then
              result=$(awk -F',' -v idx="$index_name" '
              BEGIN {IGNORECASE=1; found=0} 
              $1 == idx {print $2; found=1; exit} 
              END {if (!found) print "N/A"}' "Data/BSE.csv")
            fi
            
            if [ "$result" = "N/A" ] && [ -f "Data/nse_all_indices.csv" ]; then
              result=$(awk -F',' -v idx="$index_name" '
              BEGIN {IGNORECASE=1; found=0} 
              $1 == idx {print $2; found=1; exit} 
              END {if (!found) print "N/A"}' "Data/nse_all_indices.csv")
            fi
          fi
          
          # Clean the result (remove quotes, extra spaces)
          cleaned_result=$(echo "$result" | sed 's/"//g' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          
          # Append to output file
          echo "\"$index_name\",\"$cleaned_result\"" >> Data/QuarterlyClosing.csv
          
          # Debug output
          echo "Looking for: '$index_name' -> Found: '$cleaned_result'"
          
        done
        
        # Add timestamp row at the end (after BSE Commodities)
        echo "\"Update Time (IST):\",\"$TIMESTAMP_IST\"" >> Data/QuarterlyClosing.csv
        
        echo "Data extraction completed at $TIMESTAMP_IST IST!"
        echo "Contents of QuarterlyClosing.csv:"
        cat Data/QuarterlyClosing.csv
        
    - name: Commit and push if changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add Data/QuarterlyClosing.csv
        
        # Get IST timestamp for commit message - Set TZ again
        export TZ="Asia/Kolkata"
        COMMIT_TIMESTAMP=$(date +'%d-%b-%Y %H:%M IST')
        
        git diff --quiet && git diff --staged --quiet || (git commit -m "Update quarterly closing data - $COMMIT_TIMESTAMP [automated]" && git push)
