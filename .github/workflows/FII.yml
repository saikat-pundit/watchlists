name: Update FII Data

on:
  schedule:
    # Run daily at 7 AM UTC (12:30 PM IST) - after market data is updated
    - cron: '0 7 * * *'
  workflow_dispatch:  # Allow manual triggering
  push:
    branches: [ main ]
    paths:
      - 'Scripts/FII.py'
      - '.github/workflows/update-fii.yml'

jobs:
  update-fii:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: Run FII Data Fetcher
      id: run-script
      run: |
        echo "ðŸ“Š Starting FII data fetch..."
        python Scripts/FII.py
        EXIT_CODE=$?
        
        if [ $EXIT_CODE -eq 0 ]; then
          echo "âœ… Script executed successfully"
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "âŒ Script failed with exit code $EXIT_CODE"
          echo "status=failure" >> $GITHUB_OUTPUT
        fi
    
    - name: Check if CSV file was created
      id: check-file
      run: |
        if [ -f "Data/FII.csv" ]; then
          echo "ðŸ“ CSV file exists"
          echo "file_exists=true" >> $GITHUB_OUTPUT
          
          # Count lines in CSV
          LINE_COUNT=$(wc -l < Data/FII.csv)
          echo "lines=$LINE_COUNT" >> $GITHUB_OUTPUT
          
          # Show first few lines
          echo "ðŸ“‹ First 3 lines of CSV:"
          head -3 Data/FII.csv
        else
          echo "âŒ CSV file does not exist"
          echo "file_exists=false" >> $GITHUB_OUTPUT
          echo "lines=0" >> $GITHUB_OUTPUT
        fi
    
    - name: Setup Git config
      if: steps.check-file.outputs.file_exists == 'true'
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
    
    - name: Commit updated data
      if: steps.check-file.outputs.file_exists == 'true'
      id: commit
      run: |
        git add Data/FII.csv
        
        if git diff --cached --quiet; then
          echo "ðŸ“ No changes to commit"
          echo "changes=false" >> $GITHUB_OUTPUT
        else
          echo "ðŸ“ Changes detected, creating commit..."
          git commit -m "ðŸ¤– Auto-update FII data [$(date +'%Y-%m-%d %H:%M')]
          
          â€¢ Rows: ${{ steps.check-file.outputs.lines }}
          â€¢ Auto-updated by GitHub Actions"
          echo "âœ… Commit created"
          echo "changes=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Push changes
      if: steps.commit.outputs.changes == 'true'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}
    
    - name: Create success summary
      if: always()
      run: |
        echo "## ðŸ“Š FII Data Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ steps.run-script.outputs.status == 'success' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**CSV File:** ${{ steps.check-file.outputs.file_exists == 'true' && 'Data/FII.csv' || 'Not created' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Rows in CSV:** ${{ steps.check-file.outputs.lines }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Run Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*This update was performed automatically by GitHub Actions*" >> $GITHUB_STEP_SUMMARY
