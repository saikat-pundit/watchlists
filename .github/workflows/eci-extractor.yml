name: ECI Data Extraction

on:
  schedule:
    # Run daily at 8 AM UTC
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      multipage:
        description: 'Extract multiple pages'
        required: false
        default: false
        type: boolean

jobs:
  extract-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pyyaml
    
    - name: Create config file
      run: |
        cat > config.yaml << 'EOF'
        base_url: "https://gateway-officials.eci.gov.in/api/v1/noticeMapping/getRecords"
        bearer_token: ${{ secrets.ECI_BEARER_TOKEN }}
        pref_username: ${{ secrets.ECI_PREF_USERNAME }}
        state_cd: "S25"
        ac_no: 260
        default_part_list: "210,10,166,212,9,161,7,122,164,88,89,208,8,165,121,119,86,211,209,163,206,207,214,123,160,213,167,87,215,216,217,162,168,120"
        category_type: "ld"
        page_limit: 100
        EOF
    
    - name: Run ECI extractor
      id: extract
      run: |
        python eci_data_extractor.py --output ./data
        echo "CSV_FILE=$(ls -t ./data/*.csv | head -1)" >> $GITHUB_OUTPUT
    
    - name: Upload CSV artifact
      uses: actions/upload-artifact@v3
      with:
        name: eci-data-csv
        path: ./data/*.csv
        retention-days: 7
    
    - name: Upload JSON artifact
      uses: actions/upload-artifact@v3
      with:
        name: eci-data-json
        path: ./data/*.json
        retention-days: 7
    
    - name: Upload metadata
      uses: actions/upload-artifact@v3
      with:
        name: eci-metadata
        path: ./data/*.yaml
        retention-days: 7
    
    - name: Create data summary
      if: always()
      run: |
        echo "## ECI Data Extraction Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ steps.extract.outcome == 'success' && '✅ Success' || '❌ Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Generated Files:**" >> $GITHUB_STEP_SUMMARY
        echo "- CSV Files: $(ls -1 ./data/*.csv 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- JSON Files: $(ls -1 ./data/*.json 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Latest CSV:**" >> $GITHUB_STEP_SUMMARY
        latest_csv=$(ls -t ./data/*.csv 2>/dev/null | head -1)
        if [ -n "$latest_csv" ]; then
          echo "File: $latest_csv" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "First few lines:" >> $GITHUB_STEP_SUMMARY
          echo '```csv' >> $GITHUB_STEP_SUMMARY
          head -5 "$latest_csv" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
