name: Quarterly Closing

on:
  workflow_dispatch:  # Manual trigger from Actions tab
  schedule:
    # Runs on 1st and 16th of each month at 01:00 AM IST (19:30 UTC previous day)
    - cron: '30 19 31 * *'  # Last day of month for 1st next month at 01:00 IST
    - cron: '30 19 15 * *'  # 15th for 16th at 01:00 IST

jobs:
  process-csv:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Process CSV files and extract data
      run: |
        echo "Processing CSV files..."
        
        # Get current timestamp in IST (Indian Standard Time)
        TIMESTAMP_IST=$(TZ="Asia/Kolkata" date +'%d-%b %H:%M')
        
        # Create header for output file
        echo "Index_Name,Closing_Value" > Data/QuarterlyClosing.csv
        
        # Read each required index from BSE.csv
        {
          echo "NIFTY 50"
          echo "FINANCIAL SERVICES"
          echo "BSE Information Technology"
          echo "BSE OIL & GAS"
          echo "AUTO"
          echo "FMCG"
          echo "PHARMA"
          echo "BSE CAPITAL GOODS"
          echo "BSE POWER"
          echo "BSE Consumer Discretionary"
          echo "BSE Telecommunication"
          echo "METAL"
          echo "BSE CONSUMER DURABLES"
          echo "REALTY"
          echo "SERVICES SECTOR"
          echo "BSE India Infrastructure Index"
          echo "BSE Commodities"
        } | while read -r index_name; do
          
          # Try to find in BSE.csv first
          if [ -f "Data/BSE.csv" ]; then
            # Extract second column where first column matches (case-insensitive)
            result=$(awk -F',' -v idx="$index_name" '
            BEGIN {IGNORECASE=1; found=0} 
            $1 ~ idx {print $2; found=1; exit} 
            END {if (!found) print "N/A"}' "Data/BSE.csv")
          else
            result="N/A"
          fi
          
          # If not found in BSE.csv, try nse_all_indices.csv
          if [ "$result" = "N/A" ] || [ -z "$result" ]; then
            if [ -f "Data/nse_all_indices.csv" ]; then
              result=$(awk -F',' -v idx="$index_name" '
              BEGIN {IGNORECASE=1; found=0} 
              $1 ~ idx {print $2; found=1; exit} 
              END {if (!found) print "N/A"}' "Data/nse_all_indices.csv")
            fi
          fi
          
          # Clean the result (remove quotes, extra spaces)
          cleaned_result=$(echo "$result" | sed 's/"//g' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          
          # Append to output file
          echo "\"$index_name\",\"$cleaned_result\"" >> Data/QuarterlyClosing.csv
          
        done
        
        # Add timestamp row at the end (after BSE Commodities)
        echo "\"Timestamp\",\"$TIMESTAMP_IST\"" >> Data/QuarterlyClosing.csv
        
        echo "Data extraction completed!"
        echo "Contents of QuarterlyClosing.csv:"
        cat Data/QuarterlyClosing.csv
        
    - name: Commit and push if changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add Data/QuarterlyClosing.csv
        
        # Get IST timestamp for commit message
        COMMIT_TIMESTAMP=$(TZ="Asia/Kolkata" date +'%d-%b-%Y %H:%M IST')
        
        git diff --quiet && git diff --staged --quiet || (git commit -m "Update quarterly closing data - $COMMIT_TIMESTAMP [automated]" && git push)
